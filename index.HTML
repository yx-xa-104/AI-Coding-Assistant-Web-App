<!DOCTYPE html>
<html lang="vi" class="h-full bg-gray-900">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Coding Assistant (Streaming)</title>
    <!-- Tailwind CSS: Framework CSS ƒë·ªÉ l√†m giao di·ªán nhanh -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Monaco Editor: Tr√¨nh so·∫°n th·∫£o gi·ªëng VS Code -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.44.0/min/vs/loader.min.js"></script>
    
    <!-- Marked: Th∆∞ vi·ªán ƒë·ªÉ chuy·ªÉn ƒë·ªïi Markdown sang HTML -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
        /* T√πy ch·ªânh thanh cu·ªôn */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #1a202c; }
        ::-webkit-scrollbar-thumb { background: #4a5568; border-radius: 4px; }
        
        /* Style cho n·ªôi dung Markdown trong khung chat */
        .markdown-body p { margin-bottom: 0.5em; line-height: 1.6; }
        .markdown-body pre { background: #111827; padding: 12px; border-radius: 8px; overflow-x: auto; margin-top: 8px; border: 1px solid #374151; }
        .markdown-body code { font-family: 'Fira Code', monospace; color: #e2e8f0; font-size: 0.9em; }
        .markdown-body strong { color: #818cf8; font-weight: 700; }
        
        /* Hi·ªáu ·ª©ng nh·∫•p nh√°y cho con tr·ªè khi ƒëang g√µ */
        .cursor-blink { display: inline-block; width: 6px; height: 16px; background-color: #818cf8; animation: blink 1s infinite; vertical-align: middle; margin-left: 2px; }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0; } }
        
        .tab-active { @apply bg-indigo-600 text-white border-indigo-500; }
        .tab-inactive { @apply text-gray-400 hover:bg-gray-800 hover:text-white border-transparent; }
    </style>
</head>
<body class="h-full flex flex-col font-sans text-gray-200 bg-gray-900 overflow-hidden">

    <!-- Header -->
    <header class="bg-gray-800 border-b border-gray-700 h-14 flex items-center justify-between px-4 shrink-0 z-10">
        <div class="flex items-center gap-3">
            <div class="w-8 h-8 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-lg flex items-center justify-center shadow-lg font-bold text-white">AI</div>
            <h1 class="text-lg font-bold text-white tracking-wide">Coding Assistant <span class="text-xs text-indigo-300 bg-indigo-900/30 px-2 py-0.5 rounded ml-2">Day 4: Streaming</span></h1>
        </div>
        <!-- ƒê√®n tr·∫°ng th√°i k·∫øt n·ªëi -->
        <div class="flex items-center gap-2 px-3 py-1 bg-gray-900 rounded-full border border-gray-700">
            <div id="connection-status" class="w-2 h-2 rounded-full bg-yellow-500 animate-pulse"></div>
            <span id="connection-text" class="text-xs text-gray-400 font-medium">Checking...</span>
        </div>
    </header>

    <!-- Tabs Ng√¥n ng·ªØ -->
    <nav class="bg-gray-800 border-b border-gray-700 shrink-0">
        <div class="container mx-auto px-4 flex space-x-1 pt-2" id="tab-container">
            <!-- Tabs s·∫Ω ƒë∆∞·ª£c t·∫°o b·∫±ng JS -->
        </div>
    </nav>

    <!-- N·ªôi dung ch√≠nh -->
    <main class="flex-1 flex flex-col lg:flex-row overflow-hidden">
        <!-- C·ªôt Tr√°i: Code Editor -->
        <div class="flex-1 lg:flex-[6] flex flex-col border-r border-gray-700 min-h-[300px]">
             <div class="bg-gray-800 px-4 py-2 border-b border-gray-700 flex justify-between items-center">
                <span class="text-xs font-medium text-gray-400 uppercase tracking-wider">Editor</span>
                <button onclick="copyCode()" class="text-xs text-indigo-400 hover:text-indigo-300 flex items-center gap-1 transition-colors">
                    Copy Code
                </button>
            </div>
            <div id="editor-container" class="flex-1 bg-[#1e1e1e]"></div>
        </div>

        <!-- C·ªôt Ph·∫£i: Chat Interface -->
        <div class="flex-1 flex flex-col bg-gray-850 min-h-[400px] lg:flex-[4]">
            <!-- Khu v·ª±c hi·ªÉn th·ªã tin nh·∫Øn -->
            <div class="flex-1 p-4 overflow-y-auto space-y-4 scroll-smooth" id="chat-output">
                <!-- Tin nh·∫Øn ch√†o m·ª´ng -->
                <div class="bg-gray-800 p-4 rounded-xl border border-gray-700 shadow-sm max-w-[90%]">
                    <p class="font-medium text-indigo-400 mb-1">üëã Xin ch√†o!</p>
                    <p class="text-sm text-gray-300">H·ªá th·ªëng ƒë√£ ƒë∆∞·ª£c n√¢ng c·∫•p l√™n ch·∫ø ƒë·ªô <strong>Streaming</strong>. C√¢u tr·∫£ l·ªùi s·∫Ω xu·∫•t hi·ªán ngay l·∫≠p t·ª©c gi·ªëng nh∆∞ ChatGPT.</p>
                </div>
            </div>
            
            <!-- Khu v·ª±c nh·∫≠p li·ªáu -->
            <div class="p-4 bg-gray-800 border-t border-gray-700 shrink-0 z-20">
                <!-- Quick Actions -->
                <div class="flex gap-2 mb-3 overflow-x-auto pb-1" id="quick-actions">
                    <button onclick="setPrompt('Gi·∫£i th√≠ch chi ti·∫øt ƒëo·∫°n code n√†y')" class="whitespace-nowrap px-3 py-1.5 bg-gray-700 hover:bg-gray-600 border border-gray-600 text-xs text-gray-300 rounded-full transition-all">Gi·∫£i th√≠ch</button>
                    <button onclick="setPrompt('T√¨m l·ªói (bugs) trong ƒëo·∫°n code n√†y')" class="whitespace-nowrap px-3 py-1.5 bg-gray-700 hover:bg-gray-600 border border-gray-600 text-xs text-gray-300 rounded-full transition-all">T√¨m l·ªói</button>
                    <button onclick="setPrompt('Vi·∫øt Unit Test cho code n√†y')" class="whitespace-nowrap px-3 py-1.5 bg-gray-700 hover:bg-gray-600 border border-gray-600 text-xs text-gray-300 rounded-full transition-all">Unit Test</button>
                </div>
                
                <div class="relative">
                    <textarea id="prompt-input" rows="1" class="w-full bg-gray-900 text-white border border-gray-600 rounded-xl pl-4 pr-12 py-3 focus:outline-none focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 resize-none overflow-hidden text-sm" placeholder="H·ªèi AI v·ªÅ code c·ªßa b·∫°n..." style="min-height: 48px;"></textarea>
                    <button id="submit-button" onclick="handleSend()" class="absolute right-2 bottom-2 p-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-500 disabled:opacity-50 disabled:cursor-not-allowed transition-all">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
                        </svg>
                    </button>
                </div>
            </div>
        </div>
    </main>

    <script>
        // --- 1. C·∫§U H√åNH ·ª®NG D·ª§NG ---
        const CONFIG = {
            API_URL: 'http://localhost:3001', // C·ªïng backend streaming
            LANGUAGES: {
                'python': { label: 'Python', icon: 'üêç', default: 'def quick_sort(arr):\n    if len(arr) <= 1: return arr\n    pivot = arr[len(arr) // 2]\n    left = [x for x in arr if x < pivot]\n    middle = [x for x in arr if x == pivot]\n    right = [x for x in arr if x > pivot]\n    return quick_sort(left) + middle + quick_sort(right)' },
                'javascript': { label: 'JavaScript', icon: 'üìú', default: 'function fibonacci(n) {\n  if (n <= 1) return n;\n  return fibonacci(n - 1) + fibonacci(n - 2);\n}' },
                'cpp': { label: 'C++', icon: '‚öôÔ∏è', default: '#include <iostream>\n\nint main() {\n    std::cout << "Hello Streaming!" << std::endl;\n    return 0;\n}' }
            }
        };

        let editor;
        let currentLang = 'javascript';
        let currentAiMessageDiv = null;

        // --- 2. KH·ªûI T·∫†O MONACO EDITOR ---
        require.config({ paths: { 'vs': 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.44.0/min/vs' }});
        require(['vs/editor/editor.main'], () => {
            editor = monaco.editor.create(document.getElementById('editor-container'), {
                value: CONFIG.LANGUAGES[currentLang].default,
                language: currentLang,
                theme: 'vs-dark',
                fontSize: 14,
                fontFamily: "'Fira Code', Consolas, monospace",
                automaticLayout: true,
                minimap: { enabled: false },
                padding: { top: 16 }
            });
            renderTabs();
        });

        function renderTabs() {
            const container = document.getElementById('tab-container');
            container.innerHTML = '';
            Object.keys(CONFIG.LANGUAGES).forEach(lang => {
                const btn = document.createElement('button');
                const isActive = lang === currentLang;
                // Style cho tab
                btn.className = `px-4 py-2 text-sm font-medium border-b-2 transition-colors flex items-center gap-2 ${isActive ? 'bg-indigo-600 text-white border-indigo-500' : 'text-gray-400 hover:bg-gray-800 hover:text-white border-transparent'}`;
                btn.innerHTML = `<span>${CONFIG.LANGUAGES[lang].icon}</span> ${CONFIG.LANGUAGES[lang].label}`;
                
                btn.onclick = () => {
                    currentLang = lang;
                    editor.setModelLanguage(editor.getModel(), lang);
                    editor.setValue(CONFIG.LANGUAGES[lang].default);
                    renderTabs();
                };
                container.appendChild(btn);
            });
        }

        // --- 3. LOGIC CHAT STREAMING ---

        // H√†m th√™m tin nh·∫Øn v√†o giao di·ªán
        function addMessage(role, text = '') {
            const output = document.getElementById('chat-output');
            const div = document.createElement('div');
            const isUser = role === 'user';
            
            div.className = 'flex gap-3 animate-fade-in mb-4';
            
            // Avatar
            const avatar = isUser 
                ? '' 
                : `<div class="w-8 h-8 rounded-full bg-indigo-600 flex items-center justify-center shrink-0 text-white font-bold text-xs mt-1">AI</div>`;

            // N·ªôi dung tin nh·∫Øn
            const contentClass = isUser
                ? 'bg-gray-700 ml-auto text-white'
                : 'bg-gray-800 border border-gray-700 text-gray-200 markdown-body w-full';

            div.innerHTML = `
                ${avatar}
                <div class="${contentClass} p-3 rounded-2xl ${isUser ? 'rounded-tr-none' : 'rounded-tl-none'} text-sm shadow-md max-w-[90%]">
                    ${isUser ? text : '<span class="cursor-blink"></span>'}
                </div>
            `;
            
            output.appendChild(div);
            output.scrollTop = output.scrollHeight;
            
            // N·∫øu l√† AI, tr·∫£ v·ªÅ ph·∫ßn t·ª≠ ch·ª©a n·ªôi dung (div con) ƒë·ªÉ update text sau n√†y
            if (!isUser) {
                return div.querySelector('.markdown-body');
            }
        }

        // H√†m x·ª≠ l√Ω khi b·∫•m G·ª≠i
        async function handleSend() {
            const input = document.getElementById('prompt-input');
            const btn = document.getElementById('submit-button');
            const prompt = input.value.trim();
            if (!prompt) return;

            // 1. Hi·ªÉn th·ªã tin nh·∫Øn User
            addMessage('user', prompt);
            input.value = '';
            input.style.height = '48px'; // Reset chi·ªÅu cao textarea
            btn.disabled = true;
            btn.classList.add('opacity-50', 'cursor-not-allowed');

            // 2. T·∫°o khung tin nh·∫Øn AI (r·ªóng) ƒë·ªÉ chu·∫©n b·ªã nh·∫≠n Stream
            currentAiMessageDiv = addMessage('ai'); 

            try {
                // G·ªçi Backend
                const response = await fetch(`${CONFIG.API_URL}/generate`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        prompt: prompt,
                        codeContext: editor.getValue(),
                        language: currentLang
                    })
                });

                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.error || response.statusText);
                }

                // 3. X·ª¨ L√ù STREAM
                // L·∫•y reader ƒë·ªÉ ƒë·ªçc lu·ªìng d·ªØ li·ªáu
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let accumulatedText = ""; // Bi·∫øn t√≠ch l≈©y to√†n b·ªô vƒÉn b·∫£n nh·∫≠n ƒë∆∞·ª£c

                while (true) {
                    // ƒê·ªçc chunk ti·∫øp theo
                    const { done, value } = await reader.read();
                    
                    if (done) break;

                    // Gi·∫£i m√£ chunk (t·ª´ byte sang string)
                    const chunk = decoder.decode(value, { stream: true });
                    accumulatedText += chunk;

                    currentAiMessageDiv.innerHTML = marked.parse(accumulatedText) + '<span class="cursor-blink"></span>';
                    
                    const output = document.getElementById('chat-output');
                    output.scrollTop = output.scrollHeight;
                }
                
                // X√≥a con tr·ªè nh·∫•p nh√°y khi xong
                const cursor = currentAiMessageDiv.querySelector('.cursor-blink');
                if(cursor) cursor.remove();

            } catch (err) {
                if (currentAiMessageDiv) {
                    currentAiMessageDiv.innerHTML += `<div class="mt-2 p-2 bg-red-900/30 border border-red-700 text-red-200 rounded text-xs">‚ö†Ô∏è L·ªói: ${err.message}</div>`;
                }
            } finally {
                btn.disabled = false;
                btn.classList.remove('opacity-50', 'cursor-not-allowed');
            }
        }

        // --- 4. C√ÅC TI·ªÜN √çCH KH√ÅC ---

        // Auto-resize textarea khi g√µ
        const textarea = document.getElementById('prompt-input');
        textarea.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = (this.scrollHeight) + 'px';
            if(this.value === '') this.style.height = '48px';
        });

        // X·ª≠ l√Ω ph√≠m Enter
        textarea.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                handleSend();
            }
        });

        // H√†m cho c√°c n√∫t h√†nh ƒë·ªông nhanh
        function setPrompt(text) {
            textarea.value = text;
            handleSend();
        }

        function copyCode() {
            navigator.clipboard.writeText(editor.getValue());
            alert('ƒêo·∫°n code ƒë√£ ƒë∆∞·ª£c sao ch√©p v√†o clipboard!');
        }

        // Ki·ªÉm tra s·ª©c kh·ªèe Server ƒë·ªãnh k·ª≥ (Health Check)
        async function checkHealth() {
            const dot = document.getElementById('connection-status');
            const text = document.getElementById('connection-text');
            try {
                await fetch(`${CONFIG.API_URL}/`);
                dot.className = "w-2 h-2 rounded-full bg-green-500 shadow-[0_0_8px_rgba(34,197,94,0.6)]";
                text.innerText = "Online";
                text.className = "text-xs text-green-400 font-bold";
            } catch {
                dot.className = "w-2 h-2 rounded-full bg-red-500 shadow-[0_0_8px_rgba(239,68,68,0.6)]";
                text.innerText = "Offline";
                text.className = "text-xs text-red-400 font-bold";
            }
        }
        setInterval(checkHealth, 5000); // Check m·ªói 5 gi√¢y
        checkHealth(); // Check ngay khi m·ªü
        
    </script>
</body>
</html>